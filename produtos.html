<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="light" />
<title>Produtos â€” Ebenezer</title>

<style>
/* ===== Reset & Tokens ===== */
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --brand:#0084FF; --brand-2:#2AA7FF;
  --text:#16181d; --muted:#5a6578;
  --bg:#f5f7fb; --surface:#fff;
  --radius:16px; --radius-sm:12px;
  --border:#e9eefb;
  --shadow-sm:0 2px 10px rgba(0,0,0,.10);
  --shadow-md:0 10px 25px rgba(0,0,0,.16);
}
html,body{height:100%}
body{font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;background:var(--bg);color:var(--text);line-height:1.6}

/* ===== Navbar ===== */
.navbar{position:sticky;top:0;z-index:1000;background:#000;color:#fff;display:flex;align-items:center;gap:12px;justify-content:space-between;padding:.9rem 1.1rem;box-shadow:0 6px 24px rgba(0,0,0,.25)}
.logo{font-weight:900;letter-spacing:.3px;font-size:1.9rem;color:var(--brand)}
.logo span{color:#fff}
nav#mainNav{display:flex;align-items:center}
nav#mainNav ul{display:flex;list-style:none;gap:1.3rem}
nav#mainNav a{color:#fff;opacity:.95;font-weight:600;padding:.45rem .35rem;border-radius:10px}
nav#mainNav a:hover{opacity:1;text-decoration:underline;text-underline-offset:4px}
.menu-button{display:none;font-size:1.6rem;color:#fff;background:#111;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:.2rem .55rem;cursor:pointer}
.nav-overlay{display:none}
.nav-right{display:flex;align-items:center;gap:.6rem}
.nav-icon-container{position:relative;display:flex;align-items:center}
.nav-icon-container img{width:36px;height:36px;filter:invert(1)}
.cart-counter{position:absolute;top:-6px;right:-6px;background:#ff3b3b;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;font-weight:800}

@media (max-width:880px){
  .menu-button{display:inline-flex}
  nav#mainNav{position:fixed;top:0;right:0;height:100dvh;width:min(86vw,360px);background:#111;padding:78px 1rem 1rem;transform:translateX(100%);transition:transform .28s ease;box-shadow:-18px 0 32px rgba(0,0,0,.35);z-index:1002}
  nav#mainNav ul{flex-direction:column;gap:0}
  nav#mainNav li{border-bottom:1px solid rgba(255,255,255,.08)}
  nav#mainNav a{display:block;padding:1rem}
  nav#mainNav.show-menu{transform:translateX(0)}
  .nav-overlay{display:block;position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .28s ease;z-index:1001}
  .nav-overlay.active{opacity:1;pointer-events:auto}
}

/* ===== Top / filtros ===== */
.container{max-width:1200px;margin:0 auto;padding:1.25rem}
.header{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.header h1{font-size:clamp(1.4rem,2.8vw,1.9rem)}
.search-row{display:grid;grid-template-columns: 210px 1fr 140px;gap:.6rem;align-items:center;margin-top:.6rem}
@media (max-width:860px){ .search-row{grid-template-columns:1fr} }
.select,.input,.submit{
  border:2px solid #d7e6ff;border-radius:12px;background:#fff;box-shadow:0 4px 18px rgba(0,0,0,.05);
  padding:.7rem 1rem;font-size:1rem;outline:none;transition:.2s
}
.input:focus,.select:focus{border-color:#8abaff;box-shadow:0 0 0 4px rgba(0,132,255,.14)}
.submit{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;border:none;font-weight:800;letter-spacing:.2px;cursor:pointer}
.submit:hover{filter:brightness(1.05);transform:translateY(-1px)}
.searchbar{position:relative}
.suggest{
  position:absolute;left:0;right:0;top:calc(100% + 6px);
  background:#fff;border:1px solid #e5efff;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);
  max-height:300px;overflow:auto;z-index:10;list-style:none;padding:6px
}
.suggest li{padding:.55rem .7rem;border-radius:10px;cursor:pointer;display:flex;gap:.6rem;align-items:center}
.suggest li:hover{background:#f3f7ff}
.suggest small{color:#586272;font-weight:700;margin-left:auto}

.chips{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0}
.chip{border:1px solid var(--border);background:#fff;color:#0b60d6;font-weight:800;cursor:pointer;border-radius:999px;padding:.45rem .8rem;box-shadow:0 3px 12px rgba(0,0,0,.05)}
.chip[aria-pressed="true"]{background:#e8f2ff;border-color:#bcd8ff}

/* ===== Grid ===== */
.grid{display:grid;gap:1rem;margin-top:1rem}
.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:1100px){ .cols-4{grid-template-columns:repeat(3,1fr)} }
@media (max-width:800px){ .cols-4{grid-template-columns:repeat(2,1fr)} }
@media (max-width:580px){ .cols-4{grid-template-columns:1fr} }

/* ===== Card ===== */
.card{
  background:var(--surface);border-radius:var(--radius);padding:1rem;text-align:center;
  transition:.22s;display:flex;flex-direction:column;gap:.6rem;box-shadow:var(--shadow-sm);border:1px solid var(--border);position:relative
}
.card:hover{transform:translateY(-6px);box-shadow:var(--shadow-md)}
.badges{position:absolute;left:10px;top:10px;display:flex;gap:.4rem}
.badge{background:#ff4d4d;color:#fff;font-weight:800;padding:.2rem .5rem;border-radius:999px;font-size:.8rem}
.product-media{aspect-ratio:4/3;background:#fff;border-radius:16px;overflow:hidden;display:grid;place-items:center;box-shadow:0 6px 18px rgba(0,0,0,.06)}
.product-media img{width:100%;height:100%;object-fit:contain}
.title{font-weight:900}
.price{font-weight:900;color:#0b60d6}
.old{margin-left:.5rem;color:#8a94a6;text-decoration:line-through;font-weight:700}
.actions{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin-top:.2rem}
.btn{border:1px solid var(--border);background:#fff;font-weight:800;border-radius:12px;padding:.6rem 1rem;cursor:pointer}
.btn.primary{border:none;background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff}

/* Swatches & angles */
.swatches{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
.swatch{width:28px;height:28px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.15);cursor:pointer}
.swatch[aria-selected="true"]{box-shadow:0 0 0 2px var(--brand),0 0 0 4px #fff}
.angles{display:flex;gap:.4rem;justify-content:center}
.angle-btn{padding:.35rem .55rem;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:800}
.angle-btn[aria-pressed="true"]{background:var(--brand);color:#fff;border-color:transparent}

/* Rating (opcional) */
.star{font-size:22px;line-height:1;cursor:pointer;border:none;background:none;padding:0 2px;color:#bdbdbd;transition:.15s transform}
.star.active{color:#ffb400}.star:hover{transform:scale(1.15)}
.rating-meta{margin-left:8px;font-size:.95rem;color:#555}

/* ===== Footer ===== */
footer{background:#000;color:#fff;padding:2rem;text-align:center;border-top:1px solid rgba(255,255,255,.08);margin-top:2rem}
footer h1{margin-bottom:.4rem}
footer ul{list-style:none;display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;margin:1rem 0}
footer a{color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:.45rem .8rem}
footer a:hover{background:#fff;color:#000}
</style>
</head>
<body>

<!-- ===== NAVBAR ===== -->
<div class="navbar">
  <a class="logo" href="index.html">EBEN<span>Ã‰ZER</span></a>

  <button class="menu-button" id="menuBtn" aria-label="Abrir menu" aria-controls="mainNav" aria-expanded="false">â˜°</button>

  <nav id="mainNav" aria-label="Menu principal" aria-hidden="true">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="produtos.html" aria-current="page">Produtos</a></li>
      <li><a href="sobre.html">Sobre</a></li>
      <li><a href="contatos.html">Contatos</a></li>
      <li><a href="conta.html">Conta</a></li>
    </ul>
  </nav>
  <div class="nav-overlay" id="navOverlay" aria-hidden="true"></div>

  <div class="nav-right">
    <a class="nav-icon" href="./carrinho.html" aria-label="Ir para o carrinho">
      <img src="./images/cart.png" alt="Carrinho" />
      <span id="cartCounter" class="cart-counter">0</span>
    </a>
  </div>
</div>

<!-- ===== TOPO / BUSCA ===== -->
<section class="container">
  <div class="header">
    <h1>Produtos</h1>
    <p style="color:#586272">CatÃ¡logo completo de eletrÃ´nicos.</p>
  </div>

  <form id="searchForm" class="search-row" role="search" aria-label="Busca de produtos">
    <select id="categorySelect" class="select" aria-label="Categoria">
      <option value="">Todas as categorias</option>
      <option>Caixa de Som</option>
      <option>Headsets</option>
      <option>Smartwatches</option>
      <option>Mouses</option>
      <option>Celulares</option>
      <option>Tablets</option>
      <option>PelÃ­culas</option>
    </select>
    <div class="searchbar">
      <input id="searchInput" class="input" type="search" placeholder="ðŸ” Pesquise por nome, modelo ou categoriaâ€¦" autocomplete="off" />
      <ul id="searchSuggest" class="suggest" hidden></ul>
    </div>
    <button class="submit" type="submit">Buscar</button>
  </form>

  <div id="chipWrap" class="chips" aria-label="Departamentos">
    <button class="chip" data-chip="">Tudo</button>
    <button class="chip" data-chip="Caixa de Som">Caixa de Som</button>
    <button class="chip" data-chip="Headsets">Headsets</button>
    <button class="chip" data-chip="Smartwatches">Smartwatches</button>
    <button class="chip" data-chip="Mouses">Mouses</button>
    <button class="chip" data-chip="Celulares">Celulares</button>
    <button class="chip" data-chip="Tablets">Tablets</button>
    <button class="chip" data-chip="PelÃ­culas">PelÃ­culas</button>
  </div>
</section>

<!-- ===== GRID ===== -->
<section class="container">
  <div class="grid cols-4" id="grid" aria-live="polite"></div>
</section>

<!-- ===== FOOTER ===== -->
<footer>
  <h1>EBEN<span>Ã‰ZER</span></h1>
  <p>Conectando vocÃª ao melhor da tecnologia.</p>
  <ul>
    <li><a class="wa" href="https://wa.me/5511967040951" target="_blank" rel="noopener">WhatsApp</a></li>
    <li><a class="ig" href="https://www.instagram.com/ebenezerassistencia" target="_blank" rel="noopener">Instagram</a></li>
    <li><a class="tt" href="https://www.tiktok.com/@ebenzer.assistnci" target="_blank" rel="noopener">TikTok</a></li>
    <li><a class="yt" href="https://www.youtube.com/" target="_blank" rel="noopener">YouTube</a></li>
  </ul>
  <p>2025 â€” Todos os direitos reservados</p>
</footer>

<script>
/* ===== IMG helper: tenta .webp/.jpg/.jpeg/.png automaticamente ===== */
const IMG_BASE = './img';
const IMG_EXTS = ['webp','jpg','jpeg','png','JPG','JPEG','PNG','WEBP'];
function setVariantImage(imgEl, productId, colorKey, angleName, altBase){
  let i = 0;
  function tryNext(){
    if(i >= IMG_EXTS.length) return;
    const url = `${IMG_BASE}/${productId}/${colorKey}/${angleName}.${IMG_EXTS[i++]}`;
    imgEl.onerror = tryNext;
    imgEl.src = url;
    imgEl.alt = `${altBase || productId} â€” cor ${colorKey}, Ã¢ngulo ${angleName}`;
    imgEl.loading = 'lazy';
  }
  tryNext();
}

/* ===== MENU MOBILE ===== */
const menuBtn=document.getElementById('menuBtn');
const nav=document.getElementById('mainNav');
const overlay=document.getElementById('navOverlay');
function toggleMenu(show){
  const willOpen=typeof show==='boolean'?show:!nav.classList.contains('show-menu');
  nav.classList.toggle('show-menu',willOpen);
  overlay.classList.toggle('active',willOpen);
  menuBtn.setAttribute('aria-expanded',String(willOpen));
  nav.setAttribute('aria-hidden',String(!willOpen));
  document.body.style.overflow=willOpen?'hidden':'';
}
menuBtn.addEventListener('click',()=>toggleMenu());
overlay.addEventListener('click',()=>toggleMenu(false));
window.addEventListener('keydown',e=>{if(e.key==='Escape') toggleMenu(false);});
document.querySelectorAll('#mainNav a').forEach(a=>{
  a.addEventListener('click',e=>{
    if(nav.classList.contains('show-menu')){
      e.preventDefault();const href=a.getAttribute('href');toggleMenu(false);setTimeout(()=>location.href=href,120);
    }
  },{passive:false});
});

/* ===== CARRINHO ===== */
const cartCounter=document.getElementById('cartCounter');
let cart=[]; try{cart=JSON.parse(localStorage.getItem('cart')||'[]');}catch{cart=[];}
function updateCartCounter(){ cartCounter.textContent = cart.reduce((s,i)=>s+(i.qty||1),0); }
function addToCart(item){
  const i=cart.findIndex(x=>x.id===item.id);
  if(i>-1) cart[i].qty=(cart[i].qty||1)+(item.qty||1); else cart.push({...item,qty:item.qty||1});
  localStorage.setItem('cart',JSON.stringify(cart)); updateCartCounter();
}
updateCartCounter();

/* ===== VARIANTES ligadas Ã s SUAS PASTAS ===== */
const VARIANTS = {
  'Caixa de Som': { alt:'Caixa de Som HMASTON',
    colors:[{key:'Branco',label:'Branco',hex:'#EDEDED'}],
    angles:['1'] // adicione '2','3' se tiver mais fotos
  },
  'headset': { alt:'Headset',
    colors:[{key:'preto',label:'Preto',hex:'#111'}],
    angles:['1']
  },
  'smartwatch': { alt:'Smartwatch',
    colors:[{key:'preto',label:'Preto',hex:'#111'}],
    angles:['1']
  },
  'Mouses': { alt:'Mouse',
    colors:[{key:'Preto',label:'Preto',hex:'#111'}],
    angles:['1']
  },
  'Celulares': { alt:'Celular',
    colors:[{key:'Preto',label:'Preto',hex:'#111'}],
    angles:['1']
  },
  'Tablets': { alt:'Tablet',
    colors:[{key:'Preto',label:'Preto',hex:'#111'}],
    angles:['1']
  },
  'PelÃ­culas': { alt:'PelÃ­cula',
    colors:[{key:'Transparente',label:'Transparente',hex:'#CFCFCF'}],
    angles:['1']
  }
};

/* ===== CATÃLOGO usando seus IDs (iguais Ã s pastas) ===== */
const PRODUTOS = [
  {id:'Caixa de Som', sku:'sku-JBL', nome:'JBL-HARMAN', categoria:'Caixa de Som', preco:360.00},
  {id:'Caixa de Som',      sku:'sku-kaidi',   nome:'KAIDI',   categoria:'Headsets',    preco:160.00},
  {id:'smartwatch',   sku:'sku-swfit',   nome:'Smartwatch Fit 5ATM', categoria:'Smartwatches', preco:699.90},
  {id:'Mouses',       sku:'sku-mouse',   nome:'Mouse Gamer', categoria:'Mouses',   preco:279.90},
  {id:'Celulares',    sku:'sku-phone',   nome:'Celular X', categoria:'Celulares',  preco:1499.90},
  {id:'Tablets',      sku:'sku-tab',     nome:'Tablet Y',  categoria:'Tablets',    preco:1199.90},
  {id:'PelÃ­culas',    sku:'sku-pel',     nome:'Blindagem PoliuretÃ¢no', categoria:'PelÃ­culas', preco:45.90}
];

/* ===== BUSCA (nome + categoria) ===== */
const normalize = s => String(s||'').toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim();
const IDX = PRODUTOS.map(p=>{
  const nameNorm=normalize(p.nome), catNorm=normalize(p.categoria);
  return {...p, nameNorm, catNorm, tokens:nameNorm.split(' ')};
});
function score(p, terms, cat){
  let s=0;
  for(const t of terms){
    if(!t) continue;
    if(p.nameNorm.startsWith(t)) s+=15;
    if(p.nameNorm.includes(t)) s+=10;
    if(p.tokens.some(tok=>tok.startsWith(t))) s+=6;
    if(p.catNorm.includes(t)) s+=4;
  }
  if(cat){
    const c=normalize(cat);
    if(p.catNorm===c) s+=8; else if(p.catNorm.includes(c)) s+=4;
  }
  if(p.oldPrice && p.oldPrice>p.preco) s+=2;
  if(p.badge) s+=1;
  return s;
}
function searchProducts(query, cat){
  const terms = normalize(query).split(' ').filter(Boolean);
  const cNorm = normalize(cat||'');
  return IDX.filter(p=>{
    const termsOk = terms.every(t=> p.nameNorm.includes(t)||p.catNorm.includes(t));
    const catOk = !cNorm || p.catNorm.includes(cNorm);
    return termsOk && catOk;
  }).map(p=>({...p,__score:score(p,terms,cat)}))
    .sort((a,b)=> b.__score - a.__score || a.nome.localeCompare(b.nome));
}

/* ===== RENDER ===== */
const grid=document.getElementById('grid');
const fmtBR = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);
function cardHTML(p){
  const desconto = p.oldPrice && p.oldPrice>p.preco;
  const hasVar = !!VARIANTS[p.id];
  const detailsHref = hasVar ? `produto-detalhes-ebenezer.html?id=${encodeURIComponent(p.id)}` : '#';
  return `
  <article class="card" data-id="${p.id}">
    <div class="badges">${p.badge?`<span class="badge">${p.badge}</span>`:''}</div>
    <figure class="product-media"><img alt="${p.nome}" loading="lazy"></figure>
    <div class="title">${p.nome}</div>
    <div><span class="price">${fmtBR(p.preco)}</span> ${desconto?`<span class="old">${fmtBR(p.oldPrice)}</span>`:''}</div>

    ${hasVar?`
      <div class="swatches" role="radiogroup" aria-label="Cores de ${p.nome}"></div>
      <div class="angles" aria-label="Ã‚ngulos">
        ${ (VARIANTS[p.id].angles || ['1']).map((a,i)=>`<button class="angle-btn" data-angle="${a}" ${i===0?'aria-pressed="true"':''}>${a}</button>`).join('') }
      </div>
    `:''}

    <div class="actions">
      <button class="btn primary" data-add="${p.sku}">Adicionar</button>
      ${hasVar?`<a class="btn" data-details href="${detailsHref}">Detalhes</a>`:''}
    </div>

    <div class="rate" data-product-id="${p.sku}">
      <button class="star" data-star="1" aria-label="1 estrela">â˜†</button>
      <button class="star" data-star="2" aria-label="2 estrelas">â˜†</button>
      <button class="star" data-star="3" aria-label="3 estrelas">â˜†</button>
      <button class="star" data-star="4" aria-label="4 estrelas">â˜†</button>
      <button class="star" data-star="5" aria-label="5 estrelas">â˜†</button>
      <span class="rating-meta">â€”</span>
    </div>
  </article>`;
}
function render(list){
  if(!list.length){
    grid.innerHTML=`<div class="card" style="grid-column:1/-1;padding:2rem">
      <div class="title">Nenhum produto encontrado</div>
      <p style="color:#586272;margin-top:.4rem">Tente outros termos ou categorias.</p>
    </div>`;
    return;
  }
  grid.innerHTML = list.map(cardHTML).join('');
  bindCart(grid);
  initVariants(grid, list);
  initRatingsIn(grid);
}

/* ===== Inicializa VARIANTES no card ===== */
function initVariants(scope, list){
  scope.querySelectorAll('.card[data-id]').forEach(card=>{
    const id = card.getAttribute('data-id');
    const cfg = VARIANTS[id];
    const prod = list.find(p=>p.id===id) || PRODUTOS.find(p=>p.id===id);
    const media = card.querySelector('.product-media img');

    if(!cfg){ // sem variaÃ§Ã£o => nÃ£o usa a pasta img/
      media.src = prod.img || './images/products/product-1.png';
      media.alt = prod.nome;
      return;
    }

    // swatches
    const swWrap = card.querySelector('.swatches');
    swWrap.innerHTML='';
    (cfg.colors||[{key:'Preto',label:'Preto',hex:'#111'}]).forEach((c,i)=>{
      const b=document.createElement('button');
      b.className='swatch'; b.title=c.label; b.style.background=c.hex; b.setAttribute('role','radio'); b.dataset.color=c.key;
      if(i===0) b.setAttribute('aria-selected','true');
      swWrap.appendChild(b);
    });

    const firstColor = swWrap.querySelector('.swatch[aria-selected="true"]').dataset.color;
    const firstAngle = (card.querySelector('.angle-btn[aria-pressed="true"]')||{dataset:{angle:'1'}}).dataset.angle;

    // imagem inicial com o helper (usa sua pasta exatamente como estÃ¡)
    setVariantImage(media, id, firstColor, firstAngle, cfg.alt || prod.nome);

    // troca de cor
    swWrap.addEventListener('click', e=>{
      const btn = e.target.closest('.swatch'); if(!btn) return;
      swWrap.querySelectorAll('.swatch').forEach(x=>x.removeAttribute('aria-selected'));
      btn.setAttribute('aria-selected','true');
      const curAngle = (card.querySelector('.angle-btn[aria-pressed="true"]')||{dataset:{angle:'1'}}).dataset.angle;
      setVariantImage(media, id, btn.dataset.color, curAngle, cfg.alt || prod.nome);

      const details = card.querySelector('[data-details]');
      if(details) details.href = `produto-detalhes-ebenezer.html?id=${encodeURIComponent(id)}&color=${encodeURIComponent(btn.dataset.color)}`;
    });

    // troca de Ã¢ngulo
    const angles = card.querySelector('.angles');
    if(angles){
      angles.addEventListener('click', e=>{
        const btn = e.target.closest('.angle-btn'); if(!btn) return;
        angles.querySelectorAll('.angle-btn').forEach(x=>x.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        const curColor = swWrap.querySelector('.swatch[aria-selected="true"]').dataset.color;
        setVariantImage(media, id, curColor, btn.dataset.angle, cfg.alt || prod.nome);
      });
    }

    // link Detalhes inclui cor selecionada
    const details = card.querySelector('[data-details]');
    if(details){
      details.addEventListener('click', ()=>{
        const curColor = swWrap.querySelector('.swatch[aria-selected="true"]').dataset.color;
        details.href = `produto-detalhes-ebenezer.html?id=${encodeURIComponent(id)}&color=${encodeURIComponent(curColor)}`;
      });
    }
  });
}

/* ===== Carrinho nos cards ===== */
function bindCart(scope){
  scope.querySelectorAll('[data-add]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sku = btn.getAttribute('data-add');
      const p = PRODUTOS.find(x=>x.sku===sku); if(!p) return;
      addToCart({id:p.sku,name:p.nome,price:Number(p.preco),image:'',qty:1});
      alert(p.nome+' adicionado ao carrinho!');
    });
  });
}

/* ===== BUSCA + chips + sugestÃµes ===== */
const searchForm=document.getElementById('searchForm');
const searchInput=document.getElementById('searchInput');
const categorySelect=document.getElementById('categorySelect');
const chipWrap=document.getElementById('chipWrap');
const suggestBox=document.getElementById('searchSuggest');

function runSearch(pushUrl=true){
  const q=searchInput.value||'';
  const cat=categorySelect.value||'';
  const results = searchProducts(q,cat);
  render(results);
  if(pushUrl){
    const u=new URL(location.href);
    q?u.searchParams.set('q',q):u.searchParams.delete('q');
    cat?u.searchParams.set('cat',cat):u.searchParams.delete('cat');
    history.replaceState(null,'',u);
  }
}
function buildSuggestions(term){
  const t=normalize(term); if(!t){suggestBox.hidden=true;return;}
  const hits=[];
  for(const p of IDX){
    if(p.nameNorm.startsWith(t) || p.tokens.some(tok=>tok.startsWith(t)) || p.catNorm.startsWith(t)){
      hits.push(p); if(hits.length>=8) break;
    }
  }
  suggestBox.innerHTML = hits.map(h=>`<li data-hit="${h.sku}"><span>${h.nome}</span><small>${h.categoria}</small></li>`).join('');
  suggestBox.hidden = hits.length===0;
}
suggestBox.addEventListener('click',e=>{
  const li=e.target.closest('li[data-hit]'); if(!li) return;
  const p=PRODUTOS.find(x=>x.sku===li.getAttribute('data-hit')); if(!p) return;
  searchInput.value=p.nome; suggestBox.hidden=true; runSearch(true);
});
document.addEventListener('click',e=>{ if(!suggestBox.contains(e.target) && e.target!==searchInput) suggestBox.hidden=true; });

searchForm.addEventListener('submit',e=>{ e.preventDefault(); suggestBox.hidden=true; runSearch(true); });
searchInput.addEventListener('input',()=>buildSuggestions(searchInput.value));
categorySelect.addEventListener('change',()=>runSearch(true));
chipWrap.addEventListener('click',e=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  chipWrap.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
  chip.setAttribute('aria-pressed','true');
  categorySelect.value=chip.dataset.chip||'';
  runSearch(true);
});

/* Estado inicial via URL (?q & ?cat) */
(function hydrate(){
  const u=new URL(location.href);
  const q=u.searchParams.get('q')||''; const cat=u.searchParams.get('cat')||'';
  if(q) searchInput.value=q;
  if(cat){ categorySelect.value=cat; chipWrap.querySelector(`.chip[data-chip="${cat}"]`)?.setAttribute('aria-pressed','true'); }
  runSearch(false);
})();

/* ===== RATINGS (opcional) ===== */
const RATINGS_API='http://localhost:3001/api';
function paintStars(starBtns,value){
  starBtns.forEach(btn=>{ const v=Number(btn.dataset.star||btn.textContent.trim()); const on=v<=value; btn.classList.toggle('active',on); btn.textContent=on?'â˜…':'â˜†'; });
}
async function fetchProductRating(productId){
  try{ const res=await fetch(`${RATINGS_API}/ratings/${encodeURIComponent(productId)}`); if(!res.ok) throw 0; return res.json(); }
  catch{ return {average:0,count:0}; }
}
async function sendRating(productId,rating){
  const res=await fetch(`${RATINGS_API}/ratings`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId,rating})});
  if(!res.ok) throw new Error('Falha'); return res.json();
}
async function initRatingsIn(container=document){
  const blocks=Array.from(container.querySelectorAll('.rate[data-product-id]'));
  for(const rateEl of blocks){
    if(rateEl.dataset.bound==='1') continue; rateEl.dataset.bound='1';
    const id=rateEl.getAttribute('data-product-id'); const stars=Array.from(rateEl.querySelectorAll('.star')); const meta=rateEl.querySelector('.rating-meta');
    paintStars(stars,0); if(meta) meta.textContent='â€”';
    const data=await fetchProductRating(id); const avg=data.average?Number(data.average):0; const count=Number(data.count||0);
    paintStars(stars,Math.round(avg)); if(meta) meta.textContent = count>0?`MÃ©dia ${avg} (${count})`:'Sem avaliaÃ§Ãµes';
    stars.forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const rating=Number(btn.dataset.star||btn.textContent.trim()); if(!rating||rating<1||rating>5) return;
        try{ const r=await sendRating(id,rating); paintStars(stars,rating); if(meta){ const a=r.average?Number(r.average):rating; const c=Number(r.count||1); meta.textContent=`MÃ©dia ${a} (${c})`; } }
        catch{ alert('NÃ£o foi possÃ­vel registrar sua avaliaÃ§Ã£o.'); }
      });
    });
  }
}
</script>
</body>
</html>
